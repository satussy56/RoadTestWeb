<!doctype html>
<meta charset="utf-8">
<title>WebM → PNG Frames (with Alpha)</title>
<style>
  body { font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 24px; }
  label { display:block; margin:8px 0 4px; }
  input[type=text], input[type=number] { width: 100%; padding: 8px; }
  button { padding: 8px 14px; margin-top: 12px; }
  #log { margin-top: 12px; white-space: pre; background:#f6f6f6; padding:10px; border-radius:8px; }
</style>
<h1>WebM → PNG Frames (Alpha)</h1>
<label>Video URL (same origin recommended)</label>
<input id="url" type="text" placeholder="https://.../MV_Dance04.webm">
<label>FPS</label>
<input id="fps" type="number" value="24" min="1" step="1">
<button id="pick">フォルダ選択</button>
<button id="run">Export</button>
<div id="log"></div>

<script>
let dirHandle = null;
const $ = s => document.querySelector(s);
const log = (...a) => ($('#log').textContent += a.join(' ') + '\n');

$('#pick').onclick = async () => {
  try {
    dirHandle = await window.showDirectoryPicker();
    log('保存先フォルダを選択しました。');
  } catch (e) {
    log('キャンセルされました。');
  }
};

$('#run').onclick = async () => {
  const src = $('#url').value.trim();
  const fps = Math.max(1, parseInt($('#fps').value || '24', 10));
  if (!src) return alert('Video URL を入れてね');
  if (!dirHandle) return alert('先に出力フォルダを選んでね');

  // Video要素とCanvas準備
  const v = document.createElement('video');
  v.playsInline = true;
  v.muted = true;
  v.crossOrigin = 'anonymous'; // 同一オリジンなら不要だが保険
  v.src = src;

  try { await v.play().catch(()=>{}); } catch {}
  await new Promise(r => v.onloadedmetadata = r);
  const duration = v.duration;
  if (!isFinite(duration) || duration <= 0) return alert('動画のdurationが取れない…URLやCORSを確認してね');

  const c = document.createElement('canvas');
  c.width = v.videoWidth;
  c.height = v.videoHeight;
  const g = c.getContext('2d', { alpha: true, willReadFrequently: true });

  log(`解像度: ${c.width}x${c.height}, duration: ${duration.toFixed(3)}s, FPS: ${fps}`);

  const total = Math.ceil(duration * fps);
  for (let i = 0; i < total; i++) {
    const t = Math.min((i / fps), duration - 1e-6);
    await new Promise(resolve => { v.currentTime = t; v.onseeked = resolve; });
    g.clearRect(0,0,c.width,c.height);
    g.drawImage(v, 0, 0);

    const blob = await new Promise(res => c.toBlob(res, 'image/png'));
    const name = String(i).padStart(6,'0') + '.png';
    const fileHandle = await dirHandle.getFileHandle(name, { create: true });
    const writable = await fileHandle.createWritable();
    await writable.write(blob);
    await writable.close();

    if ((i+1) % Math.max(1, Math.floor(total/20)) === 0 || i === total-1) {
      log(`saved ${i+1}/${total} (${Math.round(((i+1)/total)*100)}%)`);
    }
  }
  log('完了！');
};
</script>