<!doctype html>
<meta charset="utf-8">
<title>WebM → PNG (Alpha)</title>
<style>
  body{font:14px system-ui;padding:20px} label{display:block;margin:8px 0 4px}
  input[type=text],input[type=number]{width:100%;padding:6px} button{padding:8px 14px;margin-top:10px}
  #log{margin-top:10px;white-space:pre-wrap;background:#f6f6f6;padding:10px;border-radius:8px}
  .err{color:#c00;font-weight:600}
</style>
<h1>WebM → PNG (Alpha)</h1>
<label>Video URL（同一オリジン推奨）</label>
<input id="url" type="text" value="https://satussy56.github.io/RoadTestWeb/movie/MV_Dance04.webm">
<label>FPS</label>
<input id="fps" type="number" value="24" min="1" step="1">
<button id="pick">出力フォルダ選択</button>
<button id="run">Export</button>
<div id="log"></div>

<script>
let dirHandle=null; const $=s=>document.querySelector(s);
const log=(...a)=>{$('#log').textContent+=a.join(' ')+'\n'}
const elog=(...a)=>{$('#log').innerHTML+=`<div class="err">${a.join(' ')}</div>`}

$('#pick').onclick=async()=>{
  try{ dirHandle=await window.showDirectoryPicker(); log('保存先フォルダOK'); }
  catch(e){ elog('フォルダ選択をキャンセル'); }
};

$('#run').onclick=async()=>{
  $('#log').textContent='';
  if(!('showDirectoryPicker' in window)) return elog('Chrome/Edgeで開いて。Safariは未対応。');
  const src=$('#url').value.trim(); const fps=Math.max(1,parseInt($('#fps').value||'24',10));
  if(!src) return elog('Video URL を入れてね');
  if(!dirHandle) return elog('先に出力フォルダを選んでね');

  const v=document.createElement('video');
  v.playsInline=true; v.muted=true; v.crossOrigin='anonymous'; v.src=src;
  try{ await v.play().catch(()=>{});}catch{}
  await new Promise(r=>v.onloadedmetadata=r);
  const c=document.createElement('canvas'); c.width=v.videoWidth; c.height=v.videoHeight;
  const g=c.getContext('2d',{alpha:true,willReadFrequently:true});

  // 再生できても CORS がNGだとこの時点で取得エラーになる
  const testDraw=()=>{
    g.clearRect(0,0,c.width,c.height);
    g.drawImage(v,0,0,1,1);
    try{ g.getImageData(0,0,1,1); return true; }
    catch(e){ elog('Canvasが汚染（tainted）されています。→ HTMLと動画を同一オリジンで配信して！'); return false; }
  };
  await new Promise(r=>v.oncanplay=r);
  if(!testDraw()) return;

  const duration=v.duration; if(!isFinite(duration)||duration<=0) return elog('duration取得失敗。URL/CORSを確認してね');
  log(`解像度 ${c.width}x${c.height}, duration ${duration.toFixed(3)}s, FPS ${fps}`);

  const total=Math.ceil(duration*fps);
  for(let i=0;i<total;i++){
    const t=Math.min(i/fps, duration-1e-6);
    await new Promise(r=>{ v.currentTime=t; v.onseeked=r; });
    g.clearRect(0,0,c.width,c.height); g.drawImage(v,0,0);
    try{
      const blob=await new Promise((res,rej)=>c.toBlob(b=>b?res(b):rej(new Error('toBlob failed')),'image/png'));
      const name=String(i).padStart(6,'0')+'.png';
      const fh=await dirHandle.getFileHandle(name,{create:true});
      const w=await fh.createWritable(); await w.write(blob); await w.close();
    }catch(e){
      elog('書き出しに失敗: '+(e&&e.message?e.message:e));
      if(e && (''+e).includes('Security')) elog('→ たぶんCORS/同一オリジン問題。');
      return;
    }
    if((i+1)%Math.max(1,Math.floor(total/20))===0||i===total-1) log(`saved ${i+1}/${total}`);
  }
  log('完了！');
};
</script>